---
title: "A mixture of hidden Markov models to predict the lymphatic spread in head and neck cancer depending on primary tumor location"
abstract: |
  Purpose: to be done

  Methods: to be done

  Results: to be done

  Conclusions: to be done
---

# Introduction
Head and Neck Squamous Cell Carcinoma (HNSCC) are known to spread through the lymphatic system and form metastases in lymph nodes [@mukherji_cervical_2001, @shah_patterns_1990]. To avoid nodal recurrences, lymph node levels (LNL) at risk of harbouring occult metastases are electively irradiated. Guidelines for different tumor locations [@biau_selection_2019] are based on the overall prevalence of nodal disease as reported in the literature [@mukherji_cervical_2001, @shah_patterns_1990].
To personalize the prediction of the risk of occult metastases, given a patient's individual diagnosis, we first published a large, multi-centric dataset where the lymphatic involvement per LNL is available for each patient[@ludwig_dataset_2022, @ludwig_multi-centric_2023].
Subsequently we published an interpretable hidden Markov model (HMM), trained with the data to predict the risk for occult nodal disease, given an individual patient's diagnosis [@ludwig_hidden_2021].
A personalized risk prediction may allow clinicians to safely reduce the elective clinical target volume (CTV-N) and reduce side-effects that degrade the patient's quality of life without compromising treatment efficacy [@batth_practical_2014].

So far we trained different models for different tumor locations such as oropharynx and oral cavity tumors. However, this approach does not describe differences in lymphatic spread between different subsites within the oropharynx and oral cavity. This resulted in distorted predictions for each subsite, as the spread patterns were pooled into one single model. To address this issue, we present an approach using mixtures of HMMs. The intuition is that the lymphatic spread of a tumor that lies anatomically at the border of oropharynx and oral cavity (e.g. tumors in the palate) may be described by a mixture of different models. We further extend the analysis to a mixture model that considers oral cavity, oropharynx, hypopharynx and larynx.


# Data on Lymphatic Progression Patterns {#sec-data}

For the analyses in this work, we used seven datasets from 5 institutions resulting in 2741 patients in total.

1. xxx oropharyngeal patients from the University of Zurich in Switzerland
2. xxx oropharyngeal patients from the Centre Léon Bérard in France
3. xxx oropharyngeal, larynx and oral cavity patients from the Inselspital Bern in Switzerland
4. xxx oropharyngeal, larynx and oral cavity patients from the Centre Léon Bérard in France
5. xxx oropharyngeal, larynx and oral cavity patients from the University of Zurich in Switzerland
6. 164 oropharyngeal patients from the Hospital Vall d'Hebron in Spain (not yet public)
7. 979 hypopharynx, larynx and oral cavity patients from University Medical Center Groningen (not yet public)

The datasets 1-4 are publicly available as CSV tables (@ludwig_multi-centric_2023 @ludwig_detailed_2022) and can be interactively explored on [LyProX](https://lyprox.org). For each patient the primary tumor subsite is reportd and each indicidual LNL is reported as either metastatic or healthy given the available diagnostic modalities, which include pathology after neck dissection in some patients. 
In this work we will stratify the tumor locations into different ICD codes which are depicted in @fig-subsites. 

![Anatomical sketch of the tumor subsites and their corresponding ICD-10 codes. Subsite C06 "other parts of mouth" has not been included. Further the The tumor locations are color coded in the following pattern: blue-oral cavity, green-oropharynx, red-hypopharynx, orange-larynx.](figures/Subsites.png){#fig-subsites}

The prevelance of involvement in LNLs I, II, III, IV and V is shown in @fig-involvement. The involvement is stratified per tumor subsite and t-stage. The figure illustrates the variations in LNL involvement between subsites within oral cavity (blue), oropharynx (green), hypopharynx (red) and larynx (orange). The involvement pattern presents a continuous change over the tumor subsites. Where tumors in the oral cavity show the most prominent LNL I involvement. As the tumor location moves towards the oropharynx LNL II involvement increases. Moving the tumor location further in caudal direction towards the hypopharynx increases LNL III involvement while LNL I and II involvement decrease. Larnygeal tumors show the least LNL I involvement.

![Prevalence of ipsilateral LNL involvement stratified by subsite. The subsites are sorted in natural order to represent the continuously changing LNL involvement. The different tumo locations are color coded, where oral cavity subsistes are depicted in blue, larynx in green, hypopharynx in red and larynx in orange. The patient data is further stratified in early t-stage (0-2) and late t-stage (3-4). The legend furter specifies the number of patients in each subsite.](figures/involvement_I_to_V_all_sites_t_staging.png){#fig-involvement}

# Unilateral Model for Lymphatic Progression {#sec-unilateral}

A patient's state of lymph node involvement $\mathbf{X}[t]$ evolves over discrete time steps $t$. Let us enumerate all $2^V$ possible states, representing all combinations of LNLs. In this paper, we consider ipsilateral LNLs I, II, III, IV and V, which amounts to 32 possible states. The HMM is specified by a transition matrix $\mathbf{A}$:

$$
\mathbf{A} = \begin{pmatrix} A_{ij} \end{pmatrix} = P \left( \mathbf{X}[t+1] = \boldsymbol{\xi}_j \mid \mathbf{X}[t] = \boldsymbol{\xi}_i \right)
$$ {#eq-transition-matrix}

whose elements $A_{ij}$ contain the conditional probabilities that a state $\mathbf{X}[t]=\boldsymbol{\xi}_i$ transitions to $\mathbf{X}[t+1]=\boldsymbol{\xi}_j$ over one time step. The transition matrix is specified and parameterised via the graphical model shown in @fig-schematic-and-graph. The red arcs in the graph of @fig-schematic-and-graph (right panel) are associated with the probability that the primary tumor spreads directly to a LNL (parameters $b_v$). The blue arcs describe the spread from an upstream LNL -- given it is already metastatic -- to a downstream level (parameters $t_{v \rightarrow v+1}$).


Now, let $\boldsymbol{\pi}$ be the _starting distribution_

$$
\boldsymbol{\pi} = \begin{pmatrix} \pi_i \end{pmatrix} = P \left( \mathbf{X}[0] = \boldsymbol{\xi}_i \right)
$$ {#eq-starting-distribution}

denoting the probability to start in state $\boldsymbol{\xi}_i$ at time step 0. Assuming that every patient started with all LNLs being healthy, we set $\pi_i$ to zero for all states  except the completly healthy state $\boldsymbol{\xi} = \begin{pmatrix} 0, 0, 0, 0 \end{pmatrix}$, which has probability one.

Using the quantities introduced so far, the probability $P \left( \mathbf{X}[t]=\boldsymbol{\xi}_i \right)$ to be in state $\boldsymbol{\theta}_i$ in time step $t$ can now be conveniently expressed as a matrix product:

$$
P \left( \mathbf{X}[t]=\boldsymbol{\xi}_i \right) = \left( \boldsymbol{\pi} \cdot \mathbf{A}^t \right)_i
$$ {#eq-evolution}

This evolution implicitly marginalizes over all possible paths to arrive at state $\boldsymbol{\xi}_i$ after $t$ time-steps. Additionally, we must marginalize over the unknown time of diagnosis using a time-prior $P_T(t)$. This finally defines the probability distribution over all states of lymph node involvement used in @eq-bayes-law.

$$
P \left( \mathbf{X}=\boldsymbol{\xi}_i \mid \boldsymbol{\theta} \right) = \sum_{t=0}^{t_\text{max}} P_T(t) \left( \boldsymbol{\pi} \cdot \mathbf{A}^t \right)_i
$$ {#eq-marginalized-evolution}


where $\boldsymbol{\theta}=\{ b_v, t_{v \rightarrow v+1} \}$ denotes the set of all model parameters (7 in our case). Fortunately, the exact length and shape of this distribution has little impact as previously shown [@ludwig_hidden_2021]. We set $t_\text{max}=$ {{< var model.max_t >}} and $P_\text{early}(t)$ to a binomial distribution with parameter {{< var model.first_binom_prob >}}. Further details on the HMM can be found in @ludwig_hidden_2021 and @zora231470.

![On the left: Anatomical sketch of the tumor subsites and corresponding ICD-10 codes considered in this work. The subsite "other parts of mouth" (C06) was not drawn. On the right: Parametrized graphical model of the lymphatic network considering four LNLs. Blue nodes represent the hidden states of LNLs $X_v$, while the red one is the tumor. Arcs represent possible routes of metastatic spread, associated with a probability.](../static/schematic_and_graph.png){#fig-schematic-and-graph fig-pos="th"}


# Mixture Model for Lymphatic Spread {#sec-mixture}

Since primary tumors at different subsites have different patterns of lymphatic spread patterns one would need to either generalize over several subsites as introduced in [@ludwig_dynamic_2021], where the HMM has been introduced for oropharyngeal cancer, or train a distinct model for each subsite. The former approach leads to less precise predictions for each subsite, especially those subsites with few patients. Training one HMM per subsite would be rather time intensive and lead to large uncertainties for subsites with only few patients such as C04 Floor of mouth or C05 Palate. Further we would not exploit the anatomical similarities which are expected for anatomically nearby locations. 

Therefore we introduce a mixture model which combines all subsites in a single model exploiting anatomical proximities. Let us assume that we have a dataset $\mathbf{D}$ that is specified via the number of patients $N_{is}$ that were diagnosed in LNL involvement state $i$ and had a primary tutor in subsite $s$. Let us further assume that we want to describe this dataset using a mixture of $M$ HMMs, each with a different set of model parameters $\boldsymbol{\theta_m}$. As the generative model of the data, we assume that a patient with subsite $s$ is generated with probability $\pi_m^s$ from model $m$, where the mixing components $\pi_m^s$ need to satisfy $\sum_{m = 1}^{M}\pi_m^s = 1$, with $\pi_m^s \geq 0$ for all $m$ and all subsites $s$. The likelihood of the dataset can then be written as  

$$
P \left( \mathbf{D} \mid \boldsymbol{\theta}, \boldsymbol{\pi}\right) = \prod_s \prod_i \left[ \sum_{m=1}^M \pi_m^s P_m \left( \mathbf{X}=\boldsymbol{\xi}_i \mid \boldsymbol{\theta}_m \right) \right]^{N_{is}}
$$ {#eq-mixture-distribution}

The model now contains two types of parameters. The rpobabilities of tumor spread for the different models, $\mathbf{\theta_m}$, and the mixing coefficients $\pi_m^s$. The posterior distribution over the parameters $P(\boldsymbol{\theta},\boldsymbol{\pi}|\mathbf{D})$ can be calculated assuming a uniform prior in the interval [0,1] for all parameters. However, $P(\boldsymbol{\theta},\boldsymbol{\pi}|\mathbf{D})$ is a multimodal-distribution as one can permute the different models. To address this problem, we apply an expectation-maximization (EM) algorithm. We introduce latent variables $\boldsymbol{\epsilon}$ which assigns to each observation $\mathbf{B}$ in our dataset the probability to originate from each model $m$. The log-likelihood can be expressed as:



$$
\ln p(\mathbf{X}|\boldsymbol{\theta},\boldsymbol{\pi}) = \left\{\sum_{\boldsymbol{\epsilon}} p(\mathbf{X},\boldsymbol{\epsilon}|\boldsymbol{\theta}, \boldsymbol{\pi})\right\}
$$ {#eq-mixture-llh}

 The EM algorithm evaluates the model parameters $\boldsymbol{\theta}$ and $\boldsymbol{\pi}$ in two steps. In the expectation step the latent variables are evaluated. To do so, we fix the current model parameters $\boldsymbol{\theta}$ and $\boldsymbol{\pi}$ and compute the expectation value of the latent variables. We can compute the expectation values $\boldsymbol{\gamma}$ of the latent variables for each observed involvement pattern $\mathbf{X}_i$ in subsite $s$ separatly.

 $$
\mathbb{E}[\epsilon_m] = \gamma(\epsilon_m^i) = \frac{\pi_m^s p(\mathbf{X}_i|\theta_m)}{\sum_{j=1}^M \pi_j^sp(\mathbf{X}_i|\theta_j)} 
 $$ {#eq-expectation-step}
 
The @eq-expectation-step includes a superscript $s$ for the mixture parameters $\pi$ which depends on the tumor subsite of diagnosis $Z_i$. 
After computing the expectation value for all components $M$ and patients $N$, the model parameters are updated by in the maximization step by maximizing the following likelihood:
$$
 \ln p(\mathbf{Z},\boldsymbol{\epsilon}|\boldsymbol{\theta},\boldsymbol{\pi}) = \sum_{i=1}^{N}\sum_{m=1}^M \gamma(\epsilon_m^i)\{\ln \pi_m^s + \ln p(Z_i|\theta_m)\}
 $$ {#eq-maximization-step}

In @eq-maximization-step one can see, that we can evaluate the mixture parameters $\boldsymbol{\pi}$ and model parameter $\boldsymbol{\theta}$ idependently of each other. The mixture parameters can be calculated analytically:

$$
\pi_m^s = \frac{1}{N^s}\sum_i^{N^s}\gamma(\epsilon_m^i)
$$ {#eq-mixture-maximization}

The model parameters $\boldsymbol{\theta}$ can be optimized component-wise with an optimization algorithm, since an analytic solution is not feasible:

$$
\ln p(\mathbf{Z},\boldsymbol{\epsilon}|\boldsymbol{\theta_m}) = \sum_{i=1}^{N} \gamma(\epsilon_m^i)\{\ln p(Z_i|\theta_m)\}
$$

By repeating these steps the algorithm is guaranteed to converge to a (local) maximum.

# Three component Mixture Model {#sec-3comp}

We illustrate the methodology for a mixture model with M = 3 components, considering the ipsilateral involvement of LNLs I, II, III, IV, and V. We include the ICD codes as subsites for oral cavity, hypopharynx and oropharynx. In @fig-convergence the convergence of the negative log-likelihood and change in model parameters is depicted. After a random inizialization, the algorithm rapidly converges.  

![The y-axis on the left shows the negative likelihood convergence depicted in the blue line. The y-axis on the right shows the sum of absulte difference between all model parameters showing that the parameter values stabilize rapidly as well.](figures/Convergence_3_comp.png){#fig-convergence}

In @fig-3_simplex, we visualize the resulting mixture coefficients $\boldsymbol{\pi}$ using a spatial representation, where the vertices of the triangle correspond to the three components. In @fig-3-matrix, these mixture coefficients are presented in matrix form, with the y-axis representing the ICD codes, showing how the mixture components in each row add up to 1.

The spatial plot in @fig-3_simplex illustrates how the model assigns the three components to different tumor subsites. Component 0, located at the bottom right of the triangle, primarily characterizes oropharyngeal subsites. For instance, the base of tongue subsite (C01), which exhibits the highest involvement of LNL II, is fully assigned to this component. Similarly, subsite C10, which includes several oropharyngeal regions, is assigned roughly 50% to the oropharynx-like component, with the remaining mixture distributed across the other two components.

Hypopharyngeal subsites, on the other hand, are fully assigned to Component 2, located at the top vertex of the triangle. Meanwhile, the gum subsite (C03), with predominant LNL I involvement, is entirely assigned to Component 1, situated at the bottom left.
As subsites anatomically approach the oropharynx, their mixture coefficients for the oropharynx-like component increase. This is evident in the subsites C02 (tongue) and C05 (palate), which display a higher proportion of oropharyngeal influence in their mixture. These results conform well with the involvement patterns observed in the data. 

::: {layout="[75,30]" layout-valign="bottom"}

![Assignment of each subsite to each of the three components. The closer a subsite is to a vertex, the more it is assigned to the corresponding component, with component 0 on the bottom right, 1 on the bottom left and 2 on the top. The size of the marker (area) corresponds to the number of patients in each subsite.](figures/mixture_components_3_simplex_t_stages_new.png){#fig-3_simplex}

![Matrix representation of component assignment. Each row of the matrix corresponds to each ICD code. The collums represent the three different components](figures/mixture_components_3_t_stages_new.png){#fig-3-matrix}
:::
